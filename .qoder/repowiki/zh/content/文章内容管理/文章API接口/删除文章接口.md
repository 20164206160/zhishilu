# 删除文章接口

<cite>
**本文档引用的文件**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java)
- [ArticleRepository.java](file://src/main/java/com/zhishilu/repository/ArticleRepository.java)
- [Article.java](file://src/main/java/com/zhishilu/entity/Article.java)
- [Result.java](file://src/main/java/com/zhishilu/common/Result.java)
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java)
- [ShiroConfig.java](file://src/main/java/com/zhishilu/config/ShiroConfig.java)
- [BusinessException.java](file://src/main/java/com/zhishilu/exception/BusinessException.java)
- [application.yml](file://src/main/resources/application.yml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

本文档详细说明了删除文章接口的完整规范，包括DELETE /api/article/{id}接口的实现细节。该接口允许已认证的用户删除自己创建的文章内容，采用基于JWT的认证机制和严格的权限控制。

## 项目结构

系统采用分层架构设计，主要包含以下层次：

```mermaid
graph TB
subgraph "表现层"
Controller[ArticleController<br/>REST控制器]
end
subgraph "业务逻辑层"
Service[ArticleService<br/>业务服务]
end
subgraph "数据访问层"
Repository[ArticleRepository<br/>数据仓库]
ES[Elasticsearch<br/>搜索引擎]
end
subgraph "实体模型层"
Entity[Article<br/>文章实体]
end
subgraph "安全层"
Shiro[ShiroConfig<br/>安全配置]
Jwt[JwtFilter<br/>JWT过滤器]
end
Controller --> Service
Service --> Repository
Repository --> ES
Service --> Entity
Shiro --> Jwt
Jwt --> Controller
```

**图表来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L22-L27)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L34-L40)
- [ArticleRepository.java](file://src/main/java/com/zhishilu/repository/ArticleRepository.java#L12-L13)
- [ShiroConfig.java](file://src/main/java/com/zhishilu/config/ShiroConfig.java#L21-L39)

**章节来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L1-L88)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L1-L200)
- [ShiroConfig.java](file://src/main/java/com/zhishilu/config/ShiroConfig.java#L1-L72)

## 核心组件

### 接口规范

DELETE /api/article/{id} 接口规范：

- **HTTP方法**: DELETE
- **URL路径**: `/api/article/{id}`
- **路径参数**: 
  - `id`: 文章唯一标识符，类型为字符串
- **请求头**: 
  - `Authorization: Bearer {token}` (必需)
  - `Content-Type: application/json`
- **响应状态码**:
  - 200: 操作成功
  - 401: 未授权
  - 403: 没有权限
  - 404: 资源不存在
  - 500: 服务器内部错误

### 数据模型

```mermaid
classDiagram
class Article {
+String id
+String title
+String category
+String content
+String url
+String[] images
+String createdBy
+String creatorId
+String location
+LocalDateTime createdTime
+LocalDateTime updatedTime
}
class ArticleRepository {
<<interface>>
+save(Article) Article
+findById(String) Optional~Article~
+deleteById(String) void
+findByCreatorId(String) Article[]
+findByCategory(String) Article[]
+findByCreatorIdAndCategory(String, String) Article[]
}
class ArticleService {
-ArticleRepository articleRepository
-ElasticsearchOperations elasticsearchOperations
+create(ArticleCreateDTO, User) Article
+update(String, ArticleUpdateDTO, User) Article
+delete(String, User) void
+getById(String) Article
+search(ArticleQueryDTO) PageResult~Article~
+getTopCategories(String, int) Map[]
}
class ArticleController {
-ArticleService articleService
+create(ArticleCreateDTO) Result~Article~
+update(String, ArticleUpdateDTO) Result~Article~
+delete(String) Result~Void~
+getById(String) Result~Article~
+list(ArticleQueryDTO) Result~PageResult~Article~~
+getTopCategories(int) Result~Map[]~
}
ArticleController --> ArticleService : 使用
ArticleService --> ArticleRepository : 依赖
ArticleService --> Article : 操作
ArticleRepository --> Article : 存储
```

**图表来源**
- [Article.java](file://src/main/java/com/zhishilu/entity/Article.java#L16-L80)
- [ArticleRepository.java](file://src/main/java/com/zhishilu/repository/ArticleRepository.java#L13-L29)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L34-L40)
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L25-L27)

**章节来源**
- [Article.java](file://src/main/java/com/zhishilu/entity/Article.java#L1-L81)
- [ArticleRepository.java](file://src/main/java/com/zhishilu/repository/ArticleRepository.java#L1-L30)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L1-L200)

## 架构概览

系统采用RESTful API架构，结合JWT认证和Shiro安全框架：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Controller as ArticleController
participant Service as ArticleService
participant Repo as ArticleRepository
participant ES as Elasticsearch
participant Security as SecurityFilter
Client->>Security : DELETE /api/article/{id}<br/>Authorization : Bearer {token}
Security->>Security : 验证JWT令牌
Security->>Controller : 放行到控制器
Controller->>Controller : 获取当前用户信息
Controller->>Service : delete(id, currentUser)
Service->>Repo : findById(id)
Repo->>ES : 查询文章记录
ES-->>Repo : 文章数据
Repo-->>Service : 文章实体
Service->>Service : 权限验证(创建者检查)
Service->>Repo : deleteById(id)
Repo->>ES : 删除文章记录
ES-->>Repo : 删除确认
Repo-->>Service : 删除完成
Service-->>Controller : 操作成功
Controller-->>Client : 200 OK + 成功消息
```

**图表来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L52-L57)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L93-L103)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L39-L75)

## 详细组件分析

### 删除接口实现流程

删除文章接口的完整执行流程如下：

```mermaid
flowchart TD
Start([开始删除请求]) --> ValidateToken["验证JWT令牌"]
ValidateToken --> TokenValid{"令牌有效?"}
TokenValid --> |否| Return401["返回401未授权"]
TokenValid --> |是| GetCurrentUser["获取当前用户"]
GetCurrentUser --> ParsePath["解析路径参数{id}"]
ParsePath --> LoadArticle["加载文章记录"]
LoadArticle --> ArticleFound{"文章存在?"}
ArticleFound --> |否| Return404["返回404资源不存在"]
ArticleFound --> |是| CheckPermission["检查删除权限"]
CheckPermission --> HasPermission{"是文章创建者?"}
HasPermission --> |否| Return403["返回403无权限"]
HasPermission --> |是| DeleteArticle["删除文章记录"]
DeleteArticle --> Return200["返回200删除成功"]
Return401 --> End([结束])
Return403 --> End
Return404 --> End
Return200 --> End
```

**图表来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L52-L57)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L93-L103)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L70-L75)

### 权限验证机制

系统实现了严格的权限控制机制：

1. **JWT认证**: 所有受保护的API都需要有效的JWT令牌
2. **创建者验证**: 只有文章的原始创建者才能删除该文章
3. **权限检查流程**:

```mermaid
flowchart LR
A[用户发起删除请求] --> B[JWT过滤器验证]
B --> C{令牌有效?}
C --> |否| D[返回401未授权]
C --> |是| E[提取用户信息]
E --> F[加载目标文章]
F --> G{文章存在?}
G --> |否| H[返回404不存在]
G --> |是| I[比较用户ID与创建者ID]
I --> J{是否相同?}
J --> |否| K[返回403无权限]
J --> |是| L[执行删除操作]
```

**图表来源**
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L93-L103)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L70-L75)

### 异常处理机制

系统采用统一的异常处理策略：

| 异常类型 | 触发条件 | HTTP状态码 | 错误信息 |
|---------|----------|------------|----------|
| BusinessException | 文章不存在 | 404 | "文章不存在" |
| BusinessException | 没有权限删除 | 403 | "没有权限删除此文章" |
| BusinessException | 业务逻辑错误 | 500 | 自定义错误消息 |
| 未捕获异常 | 系统异常 | 500 | "服务器内部错误" |

**章节来源**
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L93-L103)
- [BusinessException.java](file://src/main/java/com/zhishilu/exception/BusinessException.java#L1-L23)
- [Result.java](file://src/main/java/com/zhishilu/common/Result.java#L43-L69)

### 请求和响应格式

#### 请求示例

```http
DELETE /api/article/1234567890abcdef HTTP/1.1
Host: localhost:8080
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

#### 成功响应

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null,
  "timestamp": 1640995200000
}
```

#### 失败响应示例

**401 未授权**
```json
{
  "code": 401,
  "message": "未授权，请先登录",
  "data": null,
  "timestamp": 1640995200000
}
```

**403 无权限**
```json
{
  "code": 403,
  "message": "没有权限删除此文章",
  "data": null,
  "timestamp": 1640995200000
}
```

**404 资源不存在**
```json
{
  "code": 404,
  "message": "文章不存在",
  "data": null,
  "timestamp": 1640995200000
}
```

**章节来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L52-L57)
- [Result.java](file://src/main/java/com/zhishilu/common/Result.java#L20-L41)

## 依赖关系分析

系统各组件之间的依赖关系如下：

```mermaid
graph TD
subgraph "外部依赖"
JWT[JWT库]
Shiro[Apache Shiro]
ES[Elasticsearch]
end
subgraph "核心模块"
Controller[ArticleController]
Service[ArticleService]
Repository[ArticleRepository]
Entity[Article]
Security[SecurityFilter]
end
subgraph "工具类"
UserContext[UserContext]
Result[Result]
Config[ShiroConfig]
end
Controller --> Service
Service --> Repository
Service --> Entity
Repository --> ES
Security --> JWT
Security --> Shiro
Controller --> UserContext
Controller --> Result
Config --> Security
Service --> ES
```

**图表来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L1-L18)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L1-L30)
- [ShiroConfig.java](file://src/main/java/com/zhishilu/config/ShiroConfig.java#L1-L72)

**章节来源**
- [ArticleController.java](file://src/main/java/com/zhishilu/controller/ArticleController.java#L1-L88)
- [ArticleService.java](file://src/main/java/com/zhishilu/service/ArticleService.java#L1-L200)
- [ShiroConfig.java](file://src/main/java/com/zhishilu/config/ShiroConfig.java#L1-L72)

## 性能考虑

### 索引优化

由于文章数据存储在Elasticsearch中，系统使用了专门的索引配置：

- **索引名称**: `zhishilu_article`
- **分片数量**: 1
- **副本数量**: 0
- **字段映射**:
  - `title`: `text`类型，使用`ik_max_word`分词器
  - `content`: `text`类型，使用`ik_max_word`分词器
  - `category`: `keyword`类型，用于精确匹配
  - `createdBy`: `keyword`类型，用于用户名精确匹配

### 查询优化

- **全文搜索**: 使用`ik_smart`分词器进行智能分词
- **精确匹配**: 类别和用户名使用`keyword`类型确保精确匹配
- **时间排序**: 默认按创建时间降序排列

## 故障排除指南

### 常见问题及解决方案

#### 1. 401 未授权错误
**原因**: 缺少有效的JWT令牌或令牌格式不正确
**解决方案**:
- 确保在请求头中包含正确的Authorization头
- 验证令牌格式为`Bearer {token}`
- 检查令牌是否过期

#### 2. 403 无权限错误
**原因**: 当前用户不是文章的创建者
**解决方案**:
- 确认当前登录用户身份
- 验证文章的创建者ID与当前用户ID一致

#### 3. 404 资源不存在
**原因**: 文章ID无效或文章已被删除
**解决方案**:
- 验证文章ID格式正确
- 确认文章仍存在于数据库中

#### 4. 500 服务器内部错误
**原因**: 系统异常或数据库连接问题
**解决方案**:
- 检查服务器日志
- 验证Elasticsearch服务状态
- 确认数据库连接正常

**章节来源**
- [BusinessException.java](file://src/main/java/com/zhishilu/exception/BusinessException.java#L1-L23)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L78-L85)

## 结论

删除文章接口实现了完整的权限控制和安全验证机制。通过JWT认证确保只有合法用户能够访问，通过创建者验证确保用户只能删除自己创建的内容。系统采用Elasticsearch作为数据存储，提供了高效的全文搜索能力。整体架构清晰，职责分离明确，具有良好的可维护性和扩展性。

接口设计遵循RESTful原则，响应格式统一，便于客户端集成。异常处理机制完善，能够为客户端提供清晰的错误信息。建议在生产环境中进一步增强监控和日志记录功能，以便更好地追踪和调试问题。