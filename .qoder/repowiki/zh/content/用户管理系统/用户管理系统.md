# 用户管理系统

<cite>
**本文档引用的文件**
- [User.java](file://src/main/java/com/zhishilu/entity/User.java)
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java)
- [AuthController.java](file://src/main/java/com/zhishilu/controller/AuthController.java)
- [LoginDTO.java](file://src/main/java/com/zhishilu/dto/LoginDTO.java)
- [RegisterDTO.java](file://src/main/java/com/zhishilu/dto/RegisterDTO.java)
- [UserRepository.java](file://src/main/java/com/zhishilu/repository/UserRepository.java)
- [JwtUtil.java](file://src/main/java/com/zhishilu/util/JwtUtil.java)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java)
- [JwtRealm.java](file://src/main/java/com/zhishilu/shiro/JwtRealm.java)
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java)
- [Result.java](file://src/main/java/com/zhishilu/common/Result.java)
- [GlobalExceptionHandler.java](file://src/main/java/com/zhishilu/exception/GlobalExceptionHandler.java)
- [application.yml](file://src/main/resources/application.yml)
- [README.md](file://README.md)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [用户实体模型](#用户实体模型)
4. [认证与授权机制](#认证与授权机制)
5. [用户服务层实现](#用户服务层实现)
6. [API接口规范](#api接口规范)
7. [安全策略](#安全策略)
8. [会话管理](#会话管理)
9. [错误处理机制](#错误处理机制)
10. [使用场景与示例](#使用场景与示例)
11. [性能考虑](#性能考虑)
12. [故障排除指南](#故障排除指南)

## 项目概述

知拾录是一个基于Spring Boot构建的个人知识收藏管理系统，采用现代化的技术栈实现用户认证与权限控制。系统采用前后端分离架构，通过JWT令牌实现无状态认证，结合Apache Shiro进行权限管理。

### 核心技术栈
- **后端框架**: Spring Boot 3.2.1 + Spring MVC
- **认证授权**: Apache Shiro + JWT
- **数据存储**: Elasticsearch 8.x
- **开发工具**: Lombok
- **语言版本**: Java 17

### 主要功能特性
- 用户注册/登录认证
- 基于JWT的无状态会话管理
- 基于Shiro的权限控制
- Elasticsearch全文搜索
- 文件上传管理
- 操作日志记录

## 系统架构

```mermaid
graph TB
subgraph "客户端层"
Browser[浏览器/移动端]
MobileApp[移动应用]
end
subgraph "API网关层"
AuthController[认证控制器]
ArticleController[文章控制器]
FileController[文件控制器]
end
subgraph "服务层"
UserService[用户服务]
ArticleService[文章服务]
FileService[文件服务]
end
subgraph "数据访问层"
UserRepository[Elasticsearch仓库]
ArticleRepository[文章仓库]
FileRepository[文件仓库]
end
subgraph "基础设施"
JWT[JWT工具]
Shiro[Shiro认证]
ES[Elasticsearch]
Config[配置中心]
end
Browser --> AuthController
MobileApp --> AuthController
AuthController --> UserService
ArticleController --> ArticleService
FileController --> FileService
UserService --> UserRepository
ArticleService --> ArticleRepository
FileService --> FileRepository
UserService --> JWT
UserService --> Shiro
UserRepository --> ES
ArticleRepository --> ES
FileRepository --> ES
AuthController --> Config
UserService --> Config
```

**图表来源**
- [AuthController.java](file://src/main/java/com/zhishilu/controller/AuthController.java#L17-L20)
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L22-L25)
- [UserRepository.java](file://src/main/java/com/zhishilu/repository/UserRepository.java#L12-L13)

## 用户实体模型

用户实体是系统的核心数据模型，采用Elasticsearch文档数据库存储，支持高效的全文检索和查询。

### 实体属性设计

```mermaid
classDiagram
class User {
+String id
+String username
+String password
+String nickname
+String email
+String avatar
+Integer status
+LocalDateTime createdTime
+LocalDateTime lastLoginTime
}
class UserBuilder {
+withId(String) UserBuilder
+withUsername(String) UserBuilder
+withPassword(String) UserBuilder
+withNickname(String) UserBuilder
+withEmail(String) UserBuilder
+withAvatar(String) UserBuilder
+withStatus(Integer) UserBuilder
+withCreatedTime(LocalDateTime) UserBuilder
+withLastLoginTime(LocalDateTime) UserBuilder
+build() User
}
UserBuilder --> User : creates
```

**图表来源**
- [User.java](file://src/main/java/com/zhishilu/entity/User.java#L15-L67)

### 字段详细说明

| 字段名 | 类型 | 索引类型 | 描述 | 约束条件 |
|--------|------|----------|------|----------|
| id | String | ID | 用户唯一标识符 | UUID生成，主键 |
| username | String | Keyword | 用户名 | 唯一约束，3-20字符 |
| password | String | Keyword | 加密后的密码 | 不可索引，长度32字符 |
| nickname | String | Keyword | 昵称 | 可选，最大20字符 |
| email | String | Keyword | 邮箱地址 | 可选，邮箱格式验证 |
| avatar | String | Keyword | 头像路径 | 可选，文件存储路径 |
| status | Integer | Integer | 用户状态 | 1-正常，0-禁用，默认1 |
| createdTime | LocalDateTime | Date | 创建时间 | 自动设置 |
| lastLoginTime | LocalDateTime | Date | 最后登录时间 | 自动更新 |

### Elasticsearch映射配置

用户实体在Elasticsearch中的映射配置确保了：
- **索引优化**: 关键字字段使用Keyword类型便于精确匹配
- **搜索性能**: 时间字段使用Date类型支持范围查询
- **安全性**: 密码字段不建立索引，防止明文泄露

**章节来源**
- [User.java](file://src/main/java/com/zhishilu/entity/User.java#L13-L67)

## 认证与授权机制

系统采用JWT令牌与Apache Shiro相结合的认证授权方案，实现了无状态的用户身份验证和权限控制。

### 认证流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant AuthCtrl as 认证控制器
participant UserService as 用户服务
participant JWT as JWT工具
participant ES as Elasticsearch
Client->>AuthCtrl : POST /api/auth/login
AuthCtrl->>UserService : login(LoginDTO)
UserService->>ES : findByUsername(username)
ES-->>UserService : User对象
UserService->>UserService : 验证密码
UserService->>ES : 更新lastLoginTime
UserService->>JWT : generateToken(userId, username)
JWT-->>UserService : JWT令牌
UserService-->>AuthCtrl : {token, user}
AuthCtrl-->>Client : 成功响应
Note over Client,ES : 认证成功，返回JWT令牌
```

**图表来源**
- [AuthController.java](file://src/main/java/com/zhishilu/controller/AuthController.java#L36-L40)
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L61-L87)
- [JwtUtil.java](file://src/main/java/com/zhishilu/util/JwtUtil.java#L31-L43)

### 权限控制架构

```mermaid
graph LR
subgraph "Shiro认证链"
Filter[JwtFilter]
Realm[JwtRealm]
Token[JwtToken]
end
subgraph "用户上下文"
Context[UserContext]
ThreadLocal[ThreadLocal<User>]
end
subgraph "配置管理"
Config[ShiroConfig]
SecurityMgr[SecurityManager]
end
Filter --> Realm
Realm --> Token
Realm --> Context
Context --> ThreadLocal
Config --> SecurityMgr
SecurityMgr --> Filter
```

**图表来源**
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L29-L75)
- [JwtRealm.java](file://src/main/java/com/zhishilu/shiro/JwtRealm.java#L21-L69)
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java#L8-L32)

**章节来源**
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L29-L109)
- [JwtRealm.java](file://src/main/java/com/zhishilu/shiro/JwtRealm.java#L21-L71)
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java#L8-L33)

## 用户服务层实现

用户服务层负责处理用户相关的业务逻辑，包括注册、登录、密码处理等核心功能。

### 核心业务方法

```mermaid
flowchart TD
Start([开始]) --> ValidateRegister["验证注册参数"]
ValidateRegister --> CheckUsername["检查用户名是否存在"]
CheckUsername --> UsernameExists{"用户名已存在?"}
UsernameExists --> |是| ThrowUsernameError["抛出用户名已存在异常"]
UsernameExists --> |否| CheckEmail["检查邮箱是否存在"]
CheckEmail --> EmailExists{"邮箱已存在?"}
EmailExists --> |是| ThrowEmailError["抛出邮箱已存在异常"]
EmailExists --> |否| CreateNewUser["创建新用户"]
CreateNewUser --> EncryptPassword["加密用户密码"]
EncryptPassword --> SaveUser["保存用户到ES"]
SaveUser --> ReturnUser["返回用户信息"]
ThrowUsernameError --> End([结束])
ThrowEmailError --> End
ReturnUser --> End
```

**图表来源**
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L35-L56)

### 密码加密策略

系统采用SHA-256哈希算法配合固定盐值进行密码加密：

```mermaid
flowchart LR
PlainText[明文密码] --> Salt[添加固定盐值]
Salt --> Hash[SHA-256哈希计算]
Hash --> Iterations[1024次迭代]
Iterations --> Encrypted[加密后的密码]
subgraph "安全配置"
Secret[固定盐值: zhishilu]
Algorithm[算法: SHA-256]
IterationsCount[迭代次数: 1024]
end
Encrypted --> Store[存储到数据库]
```

**图表来源**
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L108-L110)

**章节来源**
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L25-L128)

## API接口规范

系统提供RESTful API接口，遵循统一的响应格式和错误处理机制。

### 认证接口

#### 用户注册

**请求URL**: `POST /api/auth/register`

**请求头**:
```
Content-Type: application/json
Accept: application/json
```

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 | 长度限制 |
|--------|------|------|------|----------|
| username | String | 是 | 用户名 | 3-20字符 |
| password | String | 是 | 密码 | 6-32字符 |
| nickname | String | 否 | 昵称 | 最大20字符 |
| email | String | 否 | 邮箱地址 | 邮箱格式 |

**请求示例**:
```json
{
  "username": "john_doe",
  "password": "password123",
  "nickname": "John Doe",
  "email": "john@example.com"
}
```

**响应格式**:
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": "uuid-string",
    "username": "john_doe",
    "nickname": "John Doe",
    "email": "john@example.com",
    "avatar": null,
    "status": 1,
    "createdTime": "2024-01-01T12:00:00",
    "lastLoginTime": null
  },
  "timestamp": 1704067200000
}
```

#### 用户登录

**请求URL**: `POST /api/auth/login`

**请求参数**:
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| username | String | 是 | 用户名 |
| password | String | 是 | 密码 |

**请求示例**:
```json
{
  "username": "john_doe",
  "password": "password123"
}
```

**成功响应**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "uuid-string",
      "username": "john_doe",
      "nickname": "John Doe",
      "email": "john@example.com",
      "avatar": null,
      "status": 1,
      "createdTime": "2024-01-01T12:00:00",
      "lastLoginTime": "2024-01-01T12:00:00"
    }
  },
  "timestamp": 1704067200000
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "用户名或密码错误",
  "data": null,
  "timestamp": 1704067200000
}
```

### 统一响应格式

所有API接口都遵循统一的响应格式：

```mermaid
classDiagram
class Result~T~ {
+Integer code
+String message
+T data
+Long timestamp
+success() Result~T~
+success(data) Result~T~
+success(message, data) Result~T~
+error(message) Result~T~
+error(code, message) Result~T~
+unauthorized() Result~T~
+forbidden() Result~T~
}
class SuccessResponse {
+code : 200
+message : "操作成功"
+data : T
+timestamp : 当前时间
}
class ErrorResponse {
+code : 400/401/403/500
+message : 错误描述
+data : null
+timestamp : 当前时间
}
Result --> SuccessResponse : 返回
Result --> ErrorResponse : 返回
```

**图表来源**
- [Result.java](file://src/main/java/com/zhishilu/common/Result.java#L9-L71)

**章节来源**
- [AuthController.java](file://src/main/java/com/zhishilu/controller/AuthController.java#L27-L40)
- [Result.java](file://src/main/java/com/zhishilu/common/Result.java#L20-L70)

## 安全策略

系统采用多层次的安全策略，确保用户数据和系统资源的安全性。

### JWT令牌安全

```mermaid
flowchart TD
Request[HTTP请求] --> ExtractToken[提取JWT令牌]
ExtractToken --> ValidateToken{验证令牌有效性}
ValidateToken --> |无效| Return401[返回401未授权]
ValidateToken --> |有效| ParseClaims[解析令牌声明]
ParseClaims --> GetUserId[获取用户ID]
GetUserId --> LoadUser[加载用户信息]
LoadUser --> CheckStatus{检查用户状态}
CheckStatus --> |禁用| Return403[返回403禁止访问]
CheckStatus --> |正常| Success[认证成功]
subgraph "令牌配置"
Secret[密钥: zhishilu-secret-key-must-be-at-least-256-bits-long-for-hs256]
Expiration[过期时间: 24小时]
Header[请求头: Authorization]
Prefix[令牌前缀: Bearer ]
end
```

**图表来源**
- [JwtUtil.java](file://src/main/java/com/zhishilu/util/JwtUtil.java#L31-L97)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L90-L97)

### 密码安全策略

系统采用以下密码安全措施：

1. **哈希算法**: SHA-256
2. **迭代次数**: 1024次
3. **固定盐值**: zhishilu
4. **存储方式**: 明文存储哈希值，不存储原始密码

### 数据验证规则

```mermaid
flowchart LR
Input[用户输入] --> Validation[参数验证]
Validation --> UsernameCheck{用户名验证}
UsernameCheck --> |长度3-20| PasswordCheck{密码验证}
UsernameCheck --> |长度<3或>20| Error1[用户名长度错误]
PasswordCheck --> |长度<6或>32| Error2[密码长度错误]
PasswordCheck --> EmailCheck{邮箱验证}
EmailCheck --> |格式不正确| Error3[邮箱格式错误]
EmailCheck --> |全部通过| Success[验证成功]
subgraph "验证规则"
UR[用户名: 3-20字符]
PR[密码: 6-32字符]
ER[邮箱: 格式验证]
end
```

**图表来源**
- [RegisterDTO.java](file://src/main/java/com/zhishilu/dto/RegisterDTO.java#L14-L26)
- [LoginDTO.java](file://src/main/java/com/zhishilu/dto/LoginDTO.java#L12-L16)

**章节来源**
- [JwtUtil.java](file://src/main/java/com/zhishilu/util/JwtUtil.java#L22-L27)
- [RegisterDTO.java](file://src/main/java/com/zhishilu/dto/RegisterDTO.java#L14-L27)
- [LoginDTO.java](file://src/main/java/com/zhishilu/dto/LoginDTO.java#L12-L17)

## 会话管理

系统采用JWT令牌实现无状态的会话管理，避免了传统Session的服务器端存储开销。

### 会话生命周期

```mermaid
stateDiagram-v2
[*] --> 未认证
未认证 --> 认证中 : 发起登录请求
认证中 --> 已认证 : 登录成功
认证中 --> 未认证 : 登录失败
已认证 --> 请求处理 : 携带JWT令牌
请求处理 --> 已认证 : 令牌有效
请求处理 --> 未认证 : 令牌过期
已认证 --> [*] : 用户登出
未认证 --> [*] : 服务器关闭
note right of 已认证
令牌有效期 : 24小时
用户状态 : 正常
end note
note right of 认证中
验证用户名密码
检查用户状态
end note
```

### 用户上下文管理

系统通过ThreadLocal实现用户上下文的线程安全管理：

```mermaid
classDiagram
class UserContext {
-ThreadLocal~User~ USER_HOLDER
+setCurrentUser(User) void
+getCurrentUser() User
+clear() void
}
class JwtFilter {
+onLoginSuccess(AuthenticationToken, Subject,
ServletRequest, ServletResponse) boolean
+onLoginFailure(AuthenticationToken,
AuthenticationException,
ServletRequest, ServletResponse) boolean
}
class User {
+String id
+String username
+String nickname
+String email
+Integer status
}
JwtFilter --> UserContext : 设置用户上下文
UserContext --> User : 存储当前用户
```

**图表来源**
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java#L8-L33)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L70-L75)

**章节来源**
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java#L8-L33)
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L70-L75)

## 错误处理机制

系统采用全局异常处理器统一处理各种异常情况，提供一致的错误响应格式。

### 异常分类处理

```mermaid
flowchart TD
Exception[系统异常] --> Handler[全局异常处理器]
Handler --> BusinessException[业务异常]
Handler --> AuthenticationException[认证异常]
Handler --> UnauthorizedException[授权异常]
Handler --> ValidationException[参数验证异常]
Handler --> OtherException[其他异常]
BusinessException --> BusinessResp[业务错误响应]
AuthenticationException --> AuthResp[认证错误响应]
UnauthorizedException --> UnauthResp[未授权响应]
ValidationException --> ValidResp[参数错误响应]
OtherException --> SysResp[系统错误响应]
subgraph "HTTP状态码"
BusinessResp --> Code400[400 Bad Request]
AuthResp --> Code401[401 Unauthorized]
UnauthResp --> Code403[403 Forbidden]
ValidResp --> Code400
SysResp --> Code500[500 Internal Server Error]
end
```

**图表来源**
- [GlobalExceptionHandler.java](file://src/main/java/com/zhishilu/exception/GlobalExceptionHandler.java#L22-L87)

### 错误响应格式

| 异常类型 | HTTP状态码 | 错误代码 | 错误消息示例 |
|----------|------------|----------|--------------|
| 业务异常 | 200 | 业务自定义 | 用户名已存在 |
| 认证异常 | 401 | 401 | 请先登录 |
| 授权异常 | 403 | 403 | 没有权限执行此操作 |
| 参数验证异常 | 400 | 400 | 用户名不能为空 |
| 系统异常 | 500 | 500 | 系统异常，请稍后重试 |

**章节来源**
- [GlobalExceptionHandler.java](file://src/main/java/com/zhishilu/exception/GlobalExceptionHandler.java#L27-L85)

## 使用场景与示例

### 场景一：用户注册流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant AuthCtrl as 认证控制器
participant UserService as 用户服务
participant ES as Elasticsearch
participant Redis as 缓存(可选)
Client->>AuthCtrl : POST /api/auth/register
AuthCtrl->>UserService : register(RegisterDTO)
UserService->>ES : existsByUsername(username)
ES-->>UserService : false
UserService->>ES : existsByEmail(email)
ES-->>UserService : false
UserService->>UserService : encryptPassword(password)
UserService->>ES : save(user)
ES-->>UserService : user
UserService-->>AuthCtrl : user
AuthCtrl-->>Client : 注册成功
Note over Client,ES : 注册完成，用户可立即登录
```

**图表来源**
- [AuthController.java](file://src/main/java/com/zhishilu/controller/AuthController.java#L27-L31)
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L35-L56)

### 场景二：用户登录流程

```mermaid
sequenceDiagram
participant Client as 客户端
participant AuthCtrl as 认证控制器
participant UserService as 用户服务
participant ES as Elasticsearch
participant JWT as JWT工具
Client->>AuthCtrl : POST /api/auth/login
AuthCtrl->>UserService : login(LoginDTO)
UserService->>ES : findByUsername(username)
ES-->>UserService : User
UserService->>UserService : encryptPassword(password)
UserService->>UserService : checkPassword()
UserService->>ES : update(lastLoginTime)
UserService->>JWT : generateToken(userId, username)
JWT-->>UserService : token
UserService-->>AuthCtrl : {token, user}
AuthCtrl-->>Client : 登录成功 + token
Note over Client,JWT : 返回JWT令牌，后续请求携带令牌
```

**图表来源**
- [AuthController.java](file://src/main/java/com/zhishilu/controller/AuthController.java#L36-L40)
- [UserService.java](file://src/main/java/com/zhishilu/service/UserService.java#L61-L87)

### 场景三：受保护资源访问

```mermaid
sequenceDiagram
participant Client as 客户端
participant ArticleCtrl as 文章控制器
participant ShiroFilter as Shiro过滤器
participant JwtRealm as JWT领域
participant UserContext as 用户上下文
Client->>ArticleCtrl : GET /api/article/123
ArticleCtrl->>ShiroFilter : 验证JWT令牌
ShiroFilter->>JwtRealm : 认证令牌
JwtRealm->>JwtRealm : validateToken(token)
JwtRealm->>JwtRealm : getUserIdFromToken(token)
JwtRealm->>UserService : getById(userId)
UserService-->>JwtRealm : User
JwtRealm->>JwtRealm : checkUserStatus(user)
JwtRealm-->>ShiroFilter : 认证成功
ShiroFilter->>UserContext : setCurrentUser(user)
UserContext-->>ShiroFilter : 用户上下文设置
ShiroFilter-->>ArticleCtrl : 放行请求
ArticleCtrl-->>Client : 返回文章数据
Note over Client,ArticleCtrl : 认证成功，可访问受保护资源
```

**图表来源**
- [JwtFilter.java](file://src/main/java/com/zhishilu/shiro/JwtFilter.java#L70-L75)
- [JwtRealm.java](file://src/main/java/com/zhishilu/shiro/JwtRealm.java#L44-L69)
- [UserContext.java](file://src/main/java/com/zhishilu/util/UserContext.java#L15-L24)

## 性能考虑

### 数据库优化

1. **索引策略**: 用户名和邮箱字段建立唯一索引，提高查询性能
2. **分片配置**: Elasticsearch使用单分片配置，适合小规模应用
3. **缓存策略**: 可扩展Redis缓存用户信息，减少数据库查询

### 安全性能

1. **密码哈希**: 1024次迭代提供良好的安全性和性能平衡
2. **令牌过期**: 24小时过期时间平衡安全性与用户体验
3. **连接池**: Elasticsearch连接超时配置优化网络性能

### 系统监控

```mermaid
graph TB
subgraph "监控指标"
AuthMetrics[认证指标]
ESMetrics[Elasticsearch指标]
JDBCMetrics[数据库指标]
JVMMetrics[JVM指标]
end
subgraph "监控组件"
MetricsCollector[指标收集器]
AlertSystem[告警系统]
LogAnalyzer[日志分析器]
HealthChecker[健康检查器]
end
AuthMetrics --> MetricsCollector
ESMetrics --> MetricsCollector
JDBCMetrics --> MetricsCollector
JVMMetrics --> MetricsCollector
MetricsCollector --> AlertSystem
MetricsCollector --> LogAnalyzer
MetricsCollector --> HealthChecker
```

## 故障排除指南

### 常见问题诊断

#### 1. 用户名或密码错误

**症状**: 登录时返回"用户名或密码错误"

**可能原因**:
- 用户名不存在
- 密码不正确
- 用户被禁用

**解决步骤**:
1. 验证用户名是否存在于数据库
2. 检查密码哈希是否匹配
3. 确认用户状态为正常

#### 2. JWT令牌过期

**症状**: 访问受保护资源时返回401未授权

**可能原因**:
- 令牌已过期（默认24小时）
- 服务器时间不同步
- 令牌被篡改

**解决步骤**:
1. 重新登录获取新令牌
2. 检查服务器时间配置
3. 验证令牌签名完整性

#### 3. Elasticsearch连接失败

**症状**: 注册或登录时报数据库连接错误

**可能原因**:
- Elasticsearch服务未启动
- 网络连接问题
- 认证凭据错误

**解决步骤**:
1. 检查Elasticsearch服务状态
2. 验证连接配置
3. 确认网络连通性

### 调试建议

1. **启用详细日志**: 在application.yml中调整日志级别
2. **使用Postman测试**: 验证API接口功能
3. **检查环境变量**: 确保JWT密钥和ES配置正确
4. **监控系统指标**: 关注CPU、内存、磁盘使用情况

**章节来源**
- [GlobalExceptionHandler.java](file://src/main/java/com/zhishilu/exception/GlobalExceptionHandler.java#L27-L85)
- [application.yml](file://src/main/resources/application.yml#L26-L31)